<!DOCTYPE html>
<html lang="en-us">
<head>
<base href="https://cdn.jsdelivr.net/gh/aukak/hollow-knight@latest/">
<meta charset="utf-8">
<title>Unity WebGL Player | Hollow Knight</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; overflow: hidden; font-family: Arial, sans-serif; }
    #loading-text { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 24px; }
    #unity-canvas { width: 100vw; height: 100vh; display: block; }
    #fps-graph { position: fixed; top: 12px; left: 12px; width: 200px; height: 70px; background: rgba(0,0,0,.8); border-radius: 6px; padding: 10px; z-index: 9999; transition: .3s; }
    #fps-canvas { width: 100%; height: 100%; display: block; }
    .savebtn { 
        position: fixed; top: 12px; padding: 10px 18px; cursor: pointer; 
        background: rgba(50,50,50,.85); color: #fff; border: 1px solid rgba(255,255,255,.2); 
        border-radius: 6px; font-size: 14px; z-index: 9999; transition: .3s; 
    }
    .savebtn:hover { background: rgba(70,70,70,.95); border-color: #fff; }
    #dl-btn { right: 12px; }
    #up-btn { right: 120px; }
    
    #import-overlay {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column;
        justify-content: center; align-items: center; color: white;
    }
    #progress-container { width: 300px; height: 20px; background: #333; border-radius: 10px; margin-top: 20px; overflow: hidden; }
    #progress-bar { width: 0%; height: 100%; background: #00ffcc; transition: width 0.3s; }
</style>
</head>
<body>

<div id="loading-text">Loading...</div>
<div id="import-overlay">
    <h2 id="status-msg">Preparing...</h2>
    <div id="progress-container"><div id="progress-bar"></div></div>
</div>
<canvas id="unity-canvas"></canvas>
<div id="fps-graph" style="display:none"><canvas id="fps-canvas"></canvas></div>

<input type="file" id="save-upload-input" style="display:none" accept=".dat">

<script>
const lt=document.getElementById("loading-text"),cv=document.getElementById("unity-canvas"),fg=document.getElementById("fps-graph"),fc=document.getElementById("fps-canvas");
const overlay=document.getElementById("import-overlay"),pBar=document.getElementById("progress-bar"),sMsg=document.getElementById("status-msg");
let lb=0,sb,ub;
const tm='912.81',fh=[],ml=90;fc.width=180;fc.height=50;
const ctx=fc.getContext('2d');
let lft=performance.now(),fr=0,fps=60;

function uf(){const nt=performance.now(),dt=(nt-lft)/1000;lft=nt;fps=dt>0?1/dt:60;fr++;if(fr%3===0){fh.push(fps);if(fh.length>ml)fh.shift();ctx.clearRect(0,0,180,50);for(let i=0;i<fh.length;i++){const f=fh[i],h=Math.min(f/60,1)*35,c=f>50?'#0f0':f>30?'#fa0':'#f33';ctx.fillStyle=c;ctx.fillRect(i*2,50-h,1.8,h);}ctx.fillStyle='#fff';ctx.font='bold 13px monospace';ctx.shadowColor='#000';ctx.shadowBlur=4;ctx.fillText(Math.round(fps)+' FPS',6,16);ctx.shadowBlur=0;}requestAnimationFrame(uf);}

async function fwp(u){const r=await fetch(u),rd=r.body.getReader(),ch=[];while(true){const{done,value}=await rd.read();if(done)break;lb+=value.length;ch.push(value);lt.textContent=`${(lb/1048576).toFixed(2)} MB / ${tm} MB`;}return URL.createObjectURL(new Blob(ch));}
async function mf(p){const b=await Promise.all(p.map(fwp)),bl=await Promise.all(b.map(u=>fetch(u).then(r=>r.blob())));return URL.createObjectURL(new Blob(bl));}
function gp(f,s,e){return Array.from({length:e-s+1},(_,i)=>`${f}.part${s+i}`);}

(async()=>{
    const[du,wu]=await Promise.all([mf(gp("Build/hktruffled.data",1,45)),mf(gp("Build/hktruffled.wasm",1,2))]);
    const sc=document.createElement("script");
    sc.src="Build/hktruffled.loader.js";
    sc.onload=()=>{
        createUnityInstance(cv,{dataUrl:du,frameworkUrl:"Build/hktruffled.framework.js",codeUrl:wu,streamingAssetsUrl:"StreamingAssets",companyName:"Team Cherry",productName:"Hollow Knight",productVersion:"1.0"}).then(()=>{
            lt.remove(); asb(); fg.style.display='block'; uf();
        }).catch(alert);
    };
    document.body.appendChild(sc);
})();

function asb(){
    sb=document.createElement('button'); sb.className='savebtn'; sb.id='dl-btn'; sb.textContent='Download'; sb.onclick=sdl; document.body.appendChild(sb);
    ub=document.createElement('button'); ub.className='savebtn'; ub.id='up-btn'; ub.textContent='Upload .dat'; ub.onclick=()=>document.getElementById('save-upload-input').click(); document.body.appendChild(ub);
}

document.getElementById('save-upload-input').onchange=function(e){
    if(this.files[0]) importAndWipe(this.files[0]);
};

function odb(n){ return new Promise((ok,bd)=>{const r=indexedDB.open(n);r.onsuccess=()=>ok(r.result);r.onerror=()=>bd(r.error);}); }
function ga(d,s){ return new Promise((ok,bd)=>{const t=d.transaction([s],'readonly'),st=t.objectStore(s),r=st.getAll();r.onsuccess=()=>ok(r.result);r.onerror=()=>bd(r.error);}); }

async function sdl(){
    try{
        const dbs=await indexedDB.databases(); let sv={},fd=false;
        for(const inf of dbs){
            const db=await odb(inf.name);
            for(const st of db.objectStoreNames){
                try{
                    const dt=await ga(db,st);
                    if(dt&&dt.length>0){
                        const fx=dt.map(it=>{if(it.contents&&it.contents instanceof Uint8Array){return{...it,contents:Array.from(it.contents)};}return it;});
                        sv[`${inf.name}/${st}`]=fx; fd=true;
                    }
                }catch(e){}
            }
            db.close();
        }
        if(!fd){alert('No save found');return;}
        const js=JSON.stringify(sv), bl=new Blob([js],{type:'application/octet-stream'}), u=URL.createObjectURL(bl), a=document.createElement('a');
        a.href=u; a.download='hk_save.dat'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u);
    } catch(e){ alert('Download failed: '+e.message); }
}

async function importAndWipe(file) {
    overlay.style.display = 'flex';
    pBar.style.width = '10%';
    sMsg.textContent = "Reading Local File...";

    // Step 1: Read the file first (prevents the 50% hang)
    const fileData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(new Uint8Array(e.target.result));
        reader.onerror = () => reject(new Error("Could not read local file."));
        reader.readAsArrayBuffer(file);
    });

    pBar.style.width = '40%';
    sMsg.textContent = "Connecting to Game Database...";

    try {
        const db = await odb('/idbfs');
        const paths = [
            "/idbfs/5e2f56f765046361c30ed2eb418c6b95/user1.dat",
            "/idbfs/5e2f56f765046361c30ed2eb418c6b95/user1_1.5.78.11833.dat",
            "/idbfs/8de9b686b1aa985d5128d2174ab1bc9f/user1.dat",
            "/idbfs/8de9b686b1aa985d5128d2174ab1bc9f/user1_1.5.78.11833.dat"
        ];

        pBar.style.width = '60%';
        sMsg.textContent = "Wiping & Writing Save...";

        await new Promise((resolve, reject) => {
            const tx = db.transaction(['FILE_DATA'], 'readwrite');
            const store = tx.objectStore('FILE_DATA');
            
            store.clear(); // Wipe
            
            const fileObject = { contents: fileData, timestamp: new Date() };
            paths.forEach(p => store.put(fileObject, p));

            tx.oncomplete = resolve;
            tx.onerror = () => reject(new Error("Database write failed."));
        });

        pBar.style.width = '100%';
        sMsg.textContent = "Success! Reloading...";
        setTimeout(() => location.reload(), 1200);

    } catch (err) {
        alert("Error: " + err.message);
        overlay.style.display = 'none';
    }
}
</script>
</body>
</html>
