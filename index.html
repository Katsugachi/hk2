<!doctype html>
<html lang="en-us">
<meta charset="utf-8">
<title>Unity WebGL Player | Hollow Knight</title>
<style>
@import url(https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap);
body {
  font-family: Poppins, Helvetica, Arial, sans-serif;
  margin: 0;
  background: #000;
  overflow: hidden;
}
#loading-text {
  color: #fff;
  font-size: 48px;
  font-family: Poppins;
  text-align: center;
  margin-top: 20px;
}
#unity-container {
  width: 100%;
  height: 100%;
  position: fixed;
  top: 0;
  left: 0;
}
#unity-canvas {
  width: 100%;
  height: 100%;
}
#unity-mobile-warning {
  display: none;
  color: #fff;
  text-align: center;
  padding: 20px;
}
.savebtn {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #1a1a1a;
  color: #aaa;
  border: 1px solid #333;
  padding: 10px 18px;
  margin: 4px;
  cursor: pointer;
  font-size: 12px;
  font-family: Poppins;
  transition: all 0.2s;
}
.savebtn:hover {
  background: #2a2a2a;
  color: #fff;
  border-color: #555;
}
</style>
<div id="loading-text">LOADING...</div>
<div id="unity-container" hidden>
  <canvas id="unity-canvas"></canvas>
  <div id="unity-mobile-warning">WebGL builds are not supported on mobile devices.</div>
</div>
<script>
const loadingText = document.getElementById("loading-text");
const container = document.getElementById("unity-container");
const canvas = document.getElementById("unity-canvas");
const mobileWarning = document.getElementById("unity-mobile-warning");
let loadedBytes = 0;
const totalMB = '867.84';

async function fetchWithProgress(url) {
  const response = await fetch(url);
  const reader = response.body.getReader();
  const chunks = [];
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    loadedBytes += value.length;
    chunks.push(value);
    const mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
    loadingText.textContent = `${mbDone} MB / ${totalMB} MB`;
  }
  const blob = new Blob(chunks);
  return blob.arrayBuffer();
}

async function mergeFiles(parts) {
  const buffers = await Promise.all(parts.map(fetchWithProgress));
  return URL.createObjectURL(new Blob(buffers));
}

function getParts(file, start, end) {
  return Array.from({ length: end - start + 1 }, (_, i) => `${file}.part${start + i}`);
}

(async () => {
  const [dataUrl, wasmUrl] = await Promise.all([
    mergeFiles(getParts("Build/hktruffled.data", 1, 42)),
    mergeFiles(getParts("Build/hktruffled.wasm", 1, 2))
  ]);
  
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  if (isMobile) {
    mobileWarning.style.display = "block";
    setTimeout(() => mobileWarning.style.display = "none", 5000);
  }
  
  const config = {
    dataUrl,
    frameworkUrl: "Build/hktruffled.framework.js",
    codeUrl: wasmUrl,
    companyName: "Team Cherry",
    productName: "Hollow Knight",
    productVersion: "1.0"
  };
  
  container.hidden = false;
  const script = document.createElement("script");
  script.src = "Build/hktruffled.loader.js";
  script.onload = () => {
    createUnityInstance(canvas, config, (progress) => {
      console.log(`Unity loading: ${(progress * 100).toFixed(0)}%`);
    }).then(() => {
      loadingText.remove();
      addSaveButtons();
    }).catch(alert);
  };
  document.body.appendChild(script);
})();

function addSaveButtons() {
  const d = document.createElement('div');
  d.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;display:flex;flex-direction:column';
  const b1 = document.createElement('button');
  b1.className = 'savebtn';
  b1.textContent = 'download';
  b1.onclick = saveDL;
  d.appendChild(b1);
  document.body.appendChild(d);
}

function openDB(name) {
  return new Promise((ok, bad) => {
    const r = indexedDB.open(name);
    r.onsuccess = () => ok(r.result);
    r.onerror = () => bad(r.error);
  });
}

function getAll(db, store) {
  return new Promise((ok, bad) => {
    const t = db.transaction([store], 'readonly');
    const s = t.objectStore(store);
    const r = s.getAll();
    r.onsuccess = () => ok(r.result);
    r.onerror = () => bad(r.error);
  });
}

async function saveDL() {
  try {
    const dbs = await indexedDB.databases();
    let saves = {};
    let found = false;
    for (const info of dbs) {
      const db = await openDB(info.name);
      for (const store of db.objectStoreNames) {
        try {
          const data = await getAll(db, store);
          if (data && data.length > 0) {
            const fixed = data.map(item => {
              if (item.contents && item.contents instanceof Uint8Array) {
                return { ...item, contents: Array.from(item.contents) };
              }
              return item;
            });
            saves[`${info.name}/${store}`] = fixed;
            found = true;
          }
        } catch (e) {}
      }
      db.close();
    }
    if (!found) {
      alert('no save found');
      return;
    }
    const json = JSON.stringify(saves);
    localStorage.setItem('hk_backup', json);
    const blob = new Blob([json], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'hk_save.dat';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (e) {
    alert('download failed: ' + e.message);
  }
}
</script>
</html>